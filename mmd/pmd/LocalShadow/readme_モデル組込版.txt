LocalShadow(モデル組込版)について

局所的に独自設定のセルフシャドウ描画を行う影生成エフェクト。
モデルの顔面に落ちる影を通常のライト方向と変えて、見栄えの良い影の落とし方をする
いわゆる｢嘘影｣のような効果をエフェクトで作成出来ます。

モデル組込版については、影生成に必要な情報を予めモデル側に組み込んでおくことで、通常版では
煩雑だった初期設定を自動化することが出来ます。エフェクトファイル1つをモデルに適用するだけで
影生成の効果を出せるため、ユーザー側の扱いが非常にシンプルになります。
(一応モデル制作者が必要な設定を行った上で、本エフェクトと一緒に配布されることを想定しています)



・動作環境
SM3.0対応グラフィックボードが必須になります。
MMEv0.37, MMEv0.37x64，MMMv125a，MMM64v125aで動作確認を行っています。旧バージョンでは動作しない可能性があります。



・モデルの設定方法
このエフェクトに対応させるにはPMDEditorを用いてPMD・PMXモデルを以下のように改変する必要があります。

①「LS_Center」ボーンを追加
このLS_Centerボーンがシャドウマップの中心になります。回転可能ONにして｢頭｣ボーンを親ボーンにします。
位置は顔表面の中心位置(大体両目の間くらい)になるように調整してください。

②顔材質の｢反射強度｣をキー数値に変更
顔材質(目などを含むエフェクトによる影描画を行う材質一式)を他の材質と識別できるように、｢反射強度｣に
キー数値を埋め込みます。具体的には反射強度数値の小数点以下2桁目と3桁目に決められた数値を入力します。
デフォルトでは2桁目が3, 3桁目が9で X.X39 という形になります。例えば反射強度が 5 なら 5.039, 12.3 なら 12.339 です。
キー数値についてはLocalShadow_Header.fxhで変更することも可能です。
※材質モーフで｢反射強度｣の値を変えてしまうと正常に機能しなくなるので、変更材質に材質モーフを設定する場合は注意してください。

③コントロール用のダミーモーフを追加
次のモーフを追加することで、生成する影の調整が可能になります。
   LS_LtSync : 顔に落ちる影、及び顔の陰影を照明操作に連動させる割合を調整出来ます
   LS_Blur   : 顔に落ちる影のぼかし度を調整出来ます
   LS_Dens+  : 影の濃度を濃くすることが出来ます
   LS_Dens-  : 影の濃度を薄くすることが出来ます

※上記の内①,②は必須です。必ず追加してください。③はオプションですが、あった方が都合が良いと思います。
※上記設定を一括で出来る｢モデル組込スクリプト.cx｣を同梱してありますので必要に応じてご利用ください。

④LocalShadow_Header.fxhの先頭パラメータの調整
標準的なモデルであればデフォルトのままで大体OKだと思いますが、モデルによっては好ましい初期設定に
ならない場合があります。各モデルに応じたパラメータ最適化をここで行ってください。



・使用方法[MMEの場合]
(1)組み込み設定をしたモデルをMMDにロードします。
(2)｢MMEffect｣→｢エフェクト割当｣のMainタブよりこのモデルを選択して full_LocalShadow.fx を適用します。
(3)追加した｢LS_Center｣ボーンの回転で影を落とす角度を調節できます。また追加ダミーモーフで影調整を行って下さい。



・使用方法[MMMの場合]
(1)組み込み設定をしたモデルをMMMにロードします。
(2)full_LocalShadow_MMM.fxをMMMにロードして、メインのエフェクト割り当てで組込モデルにfull_LocalShadow_MMM.fxを適用します。
   ※full_LocalShadow_MMM.fxはモデル毎に個別にロード・適用する必要があります。
(3)full_LocalShadow_MMM.fxのオフスクリーンLS_ShadowMapタブより組込モデルを選択してリスト内にある LocalShadow_ShadowMap.fxsub を適用します。
(4)追加した｢LS_Center｣ボーンの回転で影を落とす角度を調節できます。また追加ダミーモーフで影調整を行って下さい。



・他のシェーダエフェクトの改変方法
  既存のシェーダエフェクトに対応させるには、シェーダエフェクトファイルの変更が必要になります。
   ①LocalShadow_Header.fxh,LocalShadow_ShadowMap.fxsubをシェーダエフェクトのフォルダにコピーします。
   ②full_LocalShadow.fx,full_LocalShadow_MMM.fxの改変箇所と同じ変更を各シェーダエフェクトで行います。
     変更箇所についてはfull_LocalShadow.fx,full_LocalShadow_MMM.fxのコメントに書いてあるので参考にしてください。
   ※モデル組込版のfull_LocalShadow.fx,full_LocalShadow_MMM.fxは通常版のモノと中身が全く同じです。
     シェーダエフェクトをに改変する際に両者を区別する必要はありません。



・組み込みモデルの配布について(モデル制作者向け)
本エフェクト対応の組み込み設定をしたモデルを配布する際に、エフェクトファイルを同梱する場合は
｢モデル組込版｣フォルダ内にある以下の４つのファイル
   LocalShadow_Header.fxh（パラメータ最適化済み）
   LocalShadow_ShadowMap.fxsub
   full_LocalShadow.fx（他のシェーダエフェクトの対応改変したものがあればそちらでもOK）
   full_LocalShadow_MMM.fx（他のシェーダエフェクトの対応改変したものがあればそちらでもOK）
のみにして、通常版のエフェクトファイルは含まない方がユーザーの混乱が少ないと思います。

full_LocalShadow.fxについては、組み込み設定をしたモデルのファイル名(仮にXXXXXとして)を
XXXXX.pmx から XXXXX[full_LocalShadow.fx].pmx に変更、または full_LocalShadow.fx を XXXXX.fx に変更しておくと、
モデルロード時に自動でエフェクトが適用されます(モデルと同一フォルダにある場合に限ります)。



・更新履歴
v0.0.3  2014/7/10   モデル組み込み版の追加
                    影濃度の計算方法を再修正
v0.0.2  2014/7/5    コントロールモーフにLt陰影連動,Lt遮影連動,Lt影濃調整を追加。ある程度照明操作に連動出来るようにした。
                    影濃度の計算方法を一部修正
v0.0.1  2014/6/30   初回版公開


・免責事項
ご利用・改変・二次配布は自由にやっていただいてかまいません。連絡も不要です。
モデル制作者向が組み込みモデルを配布する際に、エフェクトファイルを同梱する場合も同様です。
ただしこれらの行為は全て自己責任でやってください。
このプログラム使用により、いかなる損害が生じた場合でも当方は一切の責任を負いません。


by 針金P
Twitter : @HariganeP


